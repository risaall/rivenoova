<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motor Controller</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: linear-gradient(to right, #1e1e2f, #3a3a52);
      color: #fff;
      overflow-x: hidden;
    }
    .container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      min-height: 100vh;
    }
    .lever-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100px;
      margin: 20px;
    }
    .lever-label {
      margin-bottom: 15px;
      font-weight: bold;
      font-size: 1.1em;
      text-align: center;
    }
    #leverTrack {
      position: relative;
      width: 40px;
      height: 250px;
      background: linear-gradient(to top, #555, #999);
      border-radius: 20px;
      cursor: pointer;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }
    #leverThumb {
      position: absolute;
      left: 0;
      width: 40px;
      height: 25px;
      background: #00ff88;
      border-radius: 12px;
      border: 2px solid #00cc66;
      top: 225px;
      touch-action: none;
      transition: top 0.05s linear;
    }
    .control-panel {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 20px;
      flex-grow: 1;
      max-width: 350px;
    }
    .arrow-buttons {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .arrow-buttons-row {
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .arrow-buttons button {
      width: 80px;
      height: 80px;
      font-size: 32px;
      border-radius: 50%;
      background-color: #444;
      border: 3px solid #888;
      color: #fff;
      transition: background-color 0.2s, transform 0.1s;
      user-select: none;
      touch-action: manipulation;
    }
    .arrow-buttons button:active {
      background-color: #00ff88;
      transform: scale(0.95);
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
      font-size: 1.1em;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Lever analog -->
    <div class="lever-container">
      <label class="lever-label">Speed<br/><span id="speedVal">0</span></label>
      <div id="leverTrack">
        <div id="leverThumb"></div>
      </div>
    </div>

    <!-- Control buttons -->
    <div class="control-panel">
      <div class="arrow-buttons">
        <!-- Up -->
        <div class="arrow-buttons-row arrow-up">
          <button id="btn-up">↑</button>
        </div>
        <!-- Middle row -->
        <div class="arrow-buttons-row arrow-middle">
          <button id="btn-left">←</button>
          <button id="btn-down">↓</button>
          <button id="btn-right">→</button>
        </div>
      </div>
      <!-- Status -->
      <p id="status">Motor status: -</p>
    </div>
  </div>

  <script>
    const leverTrack = document.getElementById('leverTrack');
    const leverThumb = document.getElementById('leverThumb');
    const speedVal = document.getElementById('speedVal');
    const statusText = document.getElementById('status');

    let isDraggingLever = false;
    let currentSpeed = 0;
    let currentDirection = 'stop';

    function updateLever(y) {
      const rect = leverTrack.getBoundingClientRect();
      const minY = rect.top;
      const maxY = rect.bottom;
      let clampedY = Math.min(Math.max(y, minY), maxY);
      let percent = (maxY - clampedY) / (maxY - minY); // 0..1
      let speed = Math.round(percent * 100); // MAX 100

      leverThumb.style.top = `${(1 - percent) * (leverTrack.clientHeight - leverThumb.clientHeight)}px`;

      currentSpeed = speed;
      speedVal.textContent = speed;

      if (currentDirection !== 'stop') {
        sendCommand(currentDirection, currentSpeed);
      }
    }

    leverTrack.addEventListener('pointerdown', e => {
      isDraggingLever = true;
      updateLever(e.clientY);
      e.preventDefault();
    });

    document.addEventListener('pointermove', e => {
      if (isDraggingLever) {
        updateLever(e.clientY);
        e.preventDefault();
      }
    });

    document.addEventListener('pointerup', e => {
      if (isDraggingLever) {
        isDraggingLever = false;
      }
    });

    async function sendCommand(dir, speedOverride = null) {
      const speed = speedOverride !== null ? speedOverride : currentSpeed;
      try {
        const response = await fetch(`/control?dir=${dir}&speed=${speed}`);
        if (response.ok) {
          statusText.textContent = `Sent command: ${dir} at speed ${speed}`;
        } else {
          statusText.textContent = `Error: ${response.statusText}`;
        }
      } catch (err) {
        statusText.textContent = `Fetch error: ${err}`;
      }
    }

    function setupHoldButton(buttonId, command) {
      const btn = document.getElementById(buttonId);
      let intervalId = null;

      function start() {
        currentDirection = command;
        sendCommand(currentDirection, currentSpeed);
        intervalId = setInterval(() => sendCommand(currentDirection, currentSpeed), 200);
      }

      function stop() {
        clearInterval(intervalId);
        currentDirection = 'stop';
        sendCommand(currentDirection, 0);
      }

      btn.addEventListener('mousedown', start);
      btn.addEventListener('mouseup', stop);
      btn.addEventListener('mouseleave', stop);
      btn.addEventListener('touchstart', e => {
        e.preventDefault();
        start();
      }, { passive: false });
      btn.addEventListener('touchend', stop);
    }

    setupHoldButton('btn-up', 'forward');
    setupHoldButton('btn-down', 'backward');
    setupHoldButton('btn-left', 'left');
    setupHoldButton('btn-right', 'right');

    async function updateStatus() {
      try {
        const res = await fetch('/status');
        if (res.ok) {
          const data = await res.json();
          statusText.textContent = `Motor status: Direction=${data.dir}, Speed=${data.speed}`;
        }
      } catch {}
    }
    setInterval(updateStatus, 2000);
    updateStatus();
  </script>
</body>
</html>